$(document).ready(function(){var f=$("#chatinput"),j=$("#sendbutton"),g=$("#infobtn"),d=$("#chatbox"),b=io.connect("{{ socket_uri }}"),c=!1,h=!1,k=$("#userpic"),l=$("#userinfo .name"),m=$("#userinfo .gender"),n=$("#userinfo .relationship"),o=$("#userinfo .interested_in"),p=$("#userinfo .birthday"),q=$("#m_disconnect"),r=$("#m_next"),i="Stranger",e=0;strip=function(a){var b=document.createElement("DIV");b.innerHTML=a;return b.textContent||b.innerText};scroll_to_bottom=function(){d.scrollTo("1000000000000",
200)};showmessage=function(a,b){"system"==b&&d.append("<div class='message-system'>"+a+"</div>");a=strip(a);"you"==b&&d.append("<div class='message-you'><img class='message-avatar' src='http://graph.facebook.com/{{user_fbid}}/picture/' /><p class='message-sender'>You</p><p class='message-content'>"+a+"</p></div>");"partner"==b&&(partner_avatar=0==e?"{{ STATIC_PREFIX }}img/avatar-default-small.gif":"http://graph.facebook.com/"+e+"/picture/",d.append("<div class='message-partner'><img class='message-avatar' src='"+
partner_avatar+"' /><p class='message-sender'>"+i+"</p><p class='message-content'>"+a+"</p></div>"));scroll_to_bottom()};cleanup=function(){d.html("");g.show();$("#addbtn").fadeOut("slow");$("#userdesk").animate({height:"200","border-radius":"0.3em"},500);$("#userinfo").fadeOut("slow");c=h=!1;i="Stranger";e=0;k.attr("src","{{ STATIC_PREFIX }}img/no-pic.gif")};request_reveal=function(){b.emit("e_reveal_request")};f.keydown(function(a){13==a.keyCode&&j.click()});g.click(function(){c&&(request_reveal(),
showmessage("Request sent. Waiting for partner approval","system"))});j.click(function(){if(c){var a=f.val();f.val(null);1<a.length&&(showmessage(a,"you"),b.emit("e_message",{msg:a}))}});r.click(function(){cleanup();b.emit("e_next")});q.click(function(){c&&(showmessage("Connection closed","system"),c=!1,b.emit("e_disconnect"))});$("#addbtn").click(function(){window.open("http://www.facebook.com/dialog/friends/?id="+e+"&app_id=321455234537667&display=popup&redirect_uri=http://apps.personalitycores.com/chatty/callback/",
"Add as Friend","menubar=0,resizable=1,width=580,height=420")});b.on("e_connection_success",function(){showmessage("Connection Sucessful. Say Hi! :)","system");c=!0});b.on("e_connection_disconnect",function(){showmessage("Your partner disconnected. Sorry!","system");c=!1});b.on("e_connection_error",function(a){showmessage(a.msg,"system");c=!1});b.on("e_servermessage",function(a){showmessage(a.msg,"system")});b.on("e_partnermessage",function(a){showmessage(a.msg,"partner")});b.on("e_reveal_success",
function(a){a=$.parseJSON(a.partner_data);m.html("<span>Gender:</span> "+a.gender);l.html("<span>Name:</span> <a target='blank' href='http://www.facebook.com/"+a.id+"'>"+a.first_name+" "+a.last_name+"</a>");n.html("<span>Relationship:</span> "+a.relationship_status);p.html("<span>Birthday:</span> "+a.birthday);k.attr("src","http://graph.facebook.com/"+a.id+"/picture?type=large&cache="+Math.floor(1E4*Math.random()));o.html("<span>Interested In:</span> "+a.interested_in.join(", "));i=a.first_name;e=
a.id;g.hide();$("#addbtn").fadeIn("slow");$("#userdesk").animate({height:"320px","border-radius":"0.3em 0.3em 0 0"},500);$("#userinfo").fadeIn("slow");h=!0;showmessage("Sharing complete! Check out the box!","system")});b.on("e_reveal_failure",function(){showmessage("Your Partner declined your request. Sorry!","system")});b.on("e_reveal_request",function(){!1==h&&($("#reveal_success_button").removeAttr("id"),$("#reveal_decline_button").removeAttr("id"),showmessage("Your Partner is Requesting your Data. Click <a id='reveal_success_button' href='#'>here</a> to commit or <a id='reveal_decline_button' href='#'>decline</a> the request..",
"system"),$("#reveal_success_button").click(function(){b.emit("e_reveal_success")}),$("#reveal_decline_button").click(function(){b.emit("e_reveal_failure")}))});b.emit("e_connect",{id:"{{user_fbid}}"})});